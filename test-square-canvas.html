<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>정사각형 캔버스 테스트</title>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background: #2a2a2a; 
            color: white; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .canvas-row {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }
        .canvas-wrapper {
            text-align: center;
        }
        canvas {
            background: white;
            border: 2px solid #4ade80;
            max-width: 400px;
            height: auto;
        }
        h3 { 
            color: #4ade80; 
            margin: 10px 0; 
        }
        .info {
            background: #3a3a3a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
        .status { 
            padding: 10px; 
            background: #3a3a3a; 
            border-radius: 5px; 
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 정사각형 캔버스 디자인 크기 테스트</h1>
        
        <div class="status">
            <strong>목표:</strong> 미리보기(600x720)와 저장(1500x1500) 모두에서 디자인이 티셔츠 대비 동일한 비율로 표시되어야 함
        </div>

        <div class="canvas-row">
            <div class="canvas-wrapper">
                <h3>미리보기 (600x720)</h3>
                <canvas id="preview" width="600" height="720"></canvas>
                <div class="info" id="previewInfo"></div>
            </div>
            
            <div class="canvas-wrapper">
                <h3>저장 (1500x1500)</h3>
                <canvas id="save" width="1500" height="1500" style="max-width: 400px;"></canvas>
                <div class="info" id="saveInfo"></div>
            </div>
        </div>

        <div class="status">
            <h3>📊 측정 결과</h3>
            <div id="measurements"></div>
        </div>
    </div>

    <script>
        // 전역 상태 초기화
        window.appState = {
            currentMode: 'front',
            modes: {}
        };
        
        window.outputWidth = 1500;
        window.outputHeight = 1500;

        // 테스트용 상태
        const testState = {
            designPosition: { x: 0.5, y: 0.4 },
            designScale: 0.3
        };

        function drawTest(canvasId, tshirtColor = '#d4c5a0', designColor = '#3b82f6') {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // 배경
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 티셔츠 (실제 함수와 동일한 로직)
            const tshirtWidth = 800;
            const tshirtHeight = 1000;
            const scale = Math.min(canvas.width / tshirtWidth, canvas.height / tshirtHeight) * 0.9;
            const tWidth = tshirtWidth * scale;
            const tHeight = tshirtHeight * scale;
            const tX = (canvas.width - tWidth) / 2;
            const tY = (canvas.height - tHeight) / 2;
            
            ctx.fillStyle = tshirtColor;
            ctx.fillRect(tX, tY, tWidth, tHeight);
            
            // 디자인 (개선된 스케일링 적용)
            const designWidth = 200;  // 원본 디자인 크기
            const designHeight = 200;
            
            // 기준 티셔츠 너비 (600x720 캔버스에서)
            const basePreviewTshirtWidth = 518.4;
            
            // 스케일 팩터 계산
            const scaleFactor = tWidth / basePreviewTshirtWidth;
            
            // 디자인 크기 계산
            const dWidth = designWidth * testState.designScale * scaleFactor;
            const dHeight = designHeight * testState.designScale * scaleFactor;
            
            // 위치 계산
            const dX = tX + testState.designPosition.x * tWidth - dWidth / 2;
            const dY = tY + testState.designPosition.y * tHeight - dHeight / 2;
            
            // 디자인 그리기
            ctx.fillStyle = designColor;
            ctx.beginPath();
            ctx.arc(dX + dWidth/2, dY + dHeight/2, dWidth/2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${dWidth/3}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('OK', dX + dWidth/2, dY + dHeight/2);
            
            // 정보 업데이트
            const info = document.getElementById(canvasId + 'Info');
            info.innerHTML = `
                캔버스: ${canvas.width}x${canvas.height}<br>
                티셔츠: ${Math.round(tWidth)}x${Math.round(tHeight)}<br>
                디자인: ${Math.round(dWidth)}x${Math.round(dHeight)}<br>
                디자인/티셔츠 비율: ${(dWidth/tWidth * 100).toFixed(1)}%
            `;
            
            return {
                canvas: { width: canvas.width, height: canvas.height },
                tshirt: { width: tWidth, height: tHeight },
                design: { width: dWidth, height: dHeight },
                ratio: dWidth / tWidth
            };
        }

        // 테스트 실행
        const previewResult = drawTest('preview');
        const saveResult = drawTest('save');
        
        // 결과 비교
        const measurements = document.getElementById('measurements');
        const ratioDiff = Math.abs(previewResult.ratio - saveResult.ratio);
        const isConsistent = ratioDiff < 0.01;
        
        measurements.innerHTML = `
            <p>미리보기 디자인/티셔츠 비율: <strong>${(previewResult.ratio * 100).toFixed(2)}%</strong></p>
            <p>저장 디자인/티셔츠 비율: <strong>${(saveResult.ratio * 100).toFixed(2)}%</strong></p>
            <p>차이: <strong style="color: ${isConsistent ? '#4ade80' : '#ef4444'}">${(ratioDiff * 100).toFixed(2)}%</strong></p>
            <p>결과: <strong style="color: ${isConsistent ? '#4ade80' : '#ef4444'}">${isConsistent ? '✅ 일관성 있음' : '❌ 불일치'}</strong></p>
        `;
    </script>
</body>
</html>